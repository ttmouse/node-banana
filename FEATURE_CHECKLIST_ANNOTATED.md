# Node Banana - 功能清单（带能力来源标记）

> **标记说明**:
> - ✅ **原有能力** - Node Banana 项目初始版本就包含的功能
> - 🆕 **新增能力** - 你迭代后添加的功能
> - 🔄 **增强能力** - 基于原有功能进行的优化和增强
>
> **最后更新**: 2025-12-26

---

## 📚 核心概念

### 节点工作流系统
- ✅ 节点 (Node) - 功能单元
- ✅ 连接 (Edge) - 数据流动
- ✅ 工作流 (Workflow) - 完整处理流程

### 数据类型系统
- ✅ `image` 类型 - 图片数据传递
- ✅ `text` 类型 - 文本数据传递
- ✅ `reference` 类型 - 虚拟连接（Split Grid 节点使用）

---

## 节点系统

### 1. Image Input 节点
- ✅ 加载本地图片
- ✅ 从剪贴板粘贴图片
- ✅ 拖拽图片文件到画布自动创建
- ✅ 显示图片缩略图和尺寸
- 🆕 图片数据自动缓存到 IndexedDB
- 🆕 点击图片查看原图（全屏预览）
- 🆕 快捷键创建 (`Shift + I`)

### 2. Prompt 节点
- ✅ 多行文本输入
- ✅ 自动保存输入内容
- 🆕 粘贴剪贴板文本自动创建 (`Cmd/Ctrl + V`)
- 🆕 快捷键创建 (`Shift + P`)

### 3. Nano Banana 节点（AI 图片生成）
- ✅ Google Gemini API 图片生成
- ✅ 文本提示词输入（必需）
- ✅ 参考图片输入（可选，支持多图）
- ✅ 生成参数配置（Aspect Ratio, Resolution, Model）
- ✅ Google Search 增强选项
- 🆕 再生成功能（刷新按钮）
- 🆕 状态指示（idle/loading/complete/error）
- 🆕 生成图片自动保存到全局历史记录
- 🆕 API 重试机制（失败自动重试）
- 🆕 快捷键创建 (`Shift + G`)
- 🆕 原始比例选项（Original aspect ratio）
- 🔄 图像输入变为可选（之前是必需的）

### 4. Annotation 节点
- ✅ 矩形框标注
- ✅ 圆形标注
- ✅ 箭头标注
- ✅ 自由绘制
- ✅ 文字标注
- ✅ 双击编辑标签
- ✅ 删除标注
- ✅ 多色自动分配
- 🆕 快捷键创建 (`Shift + A`)
- 🆕 从图片句柄拖拽创建并自动连接

### 5. LLM Generate 节点
- ✅ Google Gemini 文本生成
- ✅ OpenAI 文本生成
- ✅ Anthropic 支持
- ✅ 文本输入（必需）
- ✅ 图片输入（可选，多模态）
- ✅ Temperature 和 Max Tokens 配置
- 🆕 LLM 响应处理优化和重试机制
- 🆕 复制输出文本功能
- 🆕 快捷键创建 (`Shift + L`)

### 6. Split Grid 节点
- ✅ 网格检测和分割
- ✅ 自动创建子节点（ImageInput + Prompt + NanoBanana）
- ✅ 自动建立连接关系
- ✅ 网格布局排列
- 🆕 自定义网格分割（手动指定行列）
- 🆕 交互式网格选择器
- 🆕 配置面板（Target Count, Grid Rows/Cols, Default Prompt, Generate Settings）

### 7. Output 节点
- ✅ 展示最终图片
- ✅ 下载功能
- 🆕 点击查看大图

---

## 连接系统

### 连接创建
- ✅ 直接拖拽连接
- ✅ 拖拽到空白处快速创建节点（Connection Drop Menu）
- ✅ 拖拽到节点上智能连接
- 🆕 批量连接（选中多个节点同时建立连接）

### 连接类型
- ✅ Editable Edge（可编辑边）- 平滑曲线
- ✅ Reference Edge（引用边）- 灰色虚线
- 🆕 切换边样式（curved/straight）
- 🆕 暂停标记功能（Edge Toolbar）

### 连接操作
- ✅ 点击选中
- ✅ 删除连接
- 🆕 Edge Toolbar - 暂停/继续标记
- 🆕 工作流暂停点功能

---

## 画布交互

### 视图控制

#### 缩放操作
- ✅ 鼠标滚轮缩放
- 🆕 键盘快捷键缩放 (`Cmd/Ctrl + =`, `Cmd/Ctrl + -`)
- 🆕 适应视图 (`Cmd/Ctrl + 0`)
- 🆕 重置为 100% (`Cmd/Ctrl + 1`)
- 🆕 Cmd/Ctrl + 滚轮缩放（区分不同键盘布局）
- 🆕 触控板双指捏合/展开缩放
- 🆕 缩放时节点边框宽度保持固定（动态计算）

#### 平移操作
- ✅ 鼠标中键拖拽
- ✅ 触控板双指滑动
- 🆕 **空格键拖拽**（类似 Figma，按住空格键拖动画布）
- 🆕 空格键模式下禁用节点拖拽
- 🆕 空格键光标变化（grab/grabbing）
- 🆕 空格键提示显示

### 节点操作

#### 选择节点
- ✅ 单选
- ✅ 多选 (`Shift + 点击`)
- ✅ 框选（拖拽空白区域）
- 🆕 部分选择模式（SelectionMode.Partial）

#### 移动节点
- ✅ 拖拽移动
- ✅ 多选拖拽
- ✅ 分组移动
- 🆕 空格键模式下无法拖拽节点（防止误操作）
- 🆕 拖拽阈值 5px

#### 调整节点大小
- ✅ 拖拽节点边缘调整
- ✅ 多选同步调整
- 🆕 始终显示调整控件（无需预选）
- 🆕 最小尺寸限制

#### 删除节点
- ✅ `Backspace`/`Delete` 删除
- ✅ 自动删除相关连接
- 🆕 自动清理 IndexedDB 图片缓存
- 🆕 从分组中移除

#### 节点悬停效果
- ✅ 鼠标悬停显示边框
- ✅ 光标变为 pointer
- 🆕 空格键模式下不显示悬停效果（避免干扰）

### 节点排列
- 🆕 垂直堆叠 (`V` 键)
- 🆕 水平堆叠 (`H` 键)
- 🆕 网格排列 (`G` 键)

---

## 工作流执行

### 执行模式
- ✅ 完整执行（Run 按钮）
- 🆕 从节点执行（选中节点按 `Enter`）
- 🆕 暂停与继续（暂停点标记）
- ✅ 停止执行（Stop 按钮）

### 节点执行逻辑
- ✅ 拓扑排序
- ✅ 依赖优先执行
- ✅ 状态指示（loading/complete/error）
- 🆕 暂停检查
- 🆕 错误处理和友好提示

### 状态管理
- ✅ 节点状态（idle/loading/complete/error）
- ✅ 全局执行状态（isRunning）
- 🆕 当前执行节点（currentNodeId）
- 🆕 暂停位置（pausedAtNodeId）

---

## 文件管理

### 保存工作流
- ✅ 手动下载（Save 按钮）
- ✅ JSON 格式
- 🆕 自动保存（每 90 秒检查）
- 🆕 配置保存路径
- 🆕 Last saved 状态显示
- 🆕 Zustand 持久化中间件

### 加载工作流
- ✅ 拖拽 JSON 加载
- ✅ 点击 Load 加载
- ✅ 解析和验证
- 🆕 从 IndexedDB 恢复图片数据
- 🆕 自动去重节点 ID
- 🆕 自动修复损坏的连接

### 清空画布
- ✅ Clear 按钮
- ✅ 确认对话框
- 🆕 保留 IndexedDB 缓存（用于撤销）

---

## 高级功能

### 复制粘贴
- ✅ 节点复制粘贴 (`Cmd/Ctrl + C/V`)
- ✅ 内部连接保持
- 🆕 图片粘贴自动创建 ImageInput 节点
- 🆕 文本粘贴自动创建 Prompt 节点
- 🆕 跨连接复制优化
- 🆕 偏移 50px 避免重叠

### 分组功能
- 🆕 创建分组（Multi-Select Toolbar）
- 🆕 6 种颜色选项
- 🆕 可编辑分组名称
- 🆕 移动分组（拖拽头部）
- 🆕 调整分组大小
- 🆕 节点自动加入/移除分组
- 🆕 分组工具栏（改色、删除）

### 撤销/重做
- 🆕 历史栈（最多 50 个状态）
- 🆕 撤销 (`Cmd/Ctrl + Z`)
- 🆕 重做 (`Cmd/Ctrl + Shift + Z`)
- 🆕 智能保存时机（不保存视图变化）

### 全局图片历史
- ✅ 自动保存生成图片
- ✅ 历史面板显示
- ✅ 拖拽历史图片到画布
- 🆕 显示生成提示词和时间戳
- 🆕 清空历史功能

### 多选工具栏
- ✅ 显示选中节点数量
- ✅ 创建分组
- 🆕 批量再生成（Nano Banana 节点）

---

## 键盘快捷键

### 节点创建
- 🆕 `Shift + I` - Image Input
- 🆕 `Shift + P` - Prompt
- 🆕 `Shift + G` - Nano Banana
- 🆕 `Shift + L` - LLM Generate
- 🆕 `Shift + A` - Annotation

### 视图控制
- 🆕 `Cmd/Ctrl + 0` - 适应视图
- 🆕 `Cmd/Ctrl + 1` - 重置缩放
- 🆕 `Cmd/Ctrl + =` / `+` - 放大
- 🆕 `Cmd/Ctrl + -` - 缩小
- 🆕 `Cmd/Ctrl + 滚轮` - 缩放
- 🆕 `空格 + 拖拽` - 平移画布
- ✅ `中键拖拽` - 平移画布

### 编辑操作
- 🆕 `Cmd/Ctrl + C` - 复制
- 🆕 `Cmd/Ctrl + V` - 粘贴
- 🆕 `Cmd/Ctrl + Z` - 撤销
- 🆕 `Cmd/Ctrl + Shift + Z` - 重做
- ✅ `Backspace`/`Delete` - 删除
- 🆕 `Enter` - 执行工作流
- ✅ `Shift + 点击` - 多选

### 节点排列
- 🆕 `V` - 垂直堆叠
- 🆕 `H` - 水平堆叠
- 🆕 `G` - 网格排列

---

## 技术架构

### 技术栈
- ✅ React 19
- ✅ Next.js 16
- ✅ Tailwind CSS 4
- ✅ React Flow (XYFlow)
- ✅ Zustand
- ✅ Konva.js
- ✅ Canvas API
- 🆕 IndexedDB（图片缓存）
- 🆕 LocalStorage + Zustand 持久化

### 核心模块
- ✅ 状态管理（workflowStore.ts）
- 🆕 图片缓存（imageCache.ts + IndexedDB）
- ✅ 网格分割（gridSplitter.ts）
- ✅ 工作流画布（WorkflowCanvas.tsx）

---

## 其他增强

### UI/UX 改进
- 🆕 功能文档查看器（FeatureDocsModal）
- 🆕 右键菜单禁用（避免干扰）
- 🆕 选择模式优化（Partial）
- 🆕 节点边框固定宽度（缩放时保持清晰）
- 🆕 光标交互优化（空格键、悬停）
- 🆕 全屏图片预览

### 性能优化
- 🆕 图片数据缓存到 IndexedDB（避免 localStorage 限制）
- 🆕 工作流自动保存（持久化中间件）
- 🆕 API 重试机制（提高稳定性）
- 🆕 节点 ID 去重（防止冲突）

---

**总结**:
- **原有能力（✅）**: 基础节点系统、工作流执行、图片生成、标注、保存/加载
- **新增能力（🆕）**: 快捷键系统、空格键交互、撤销/重做、分组、图片缓存、自动保存、从节点执行、暂停点、批量操作、节点排列等
- **增强能力（🔄）**: 图像输入可选化、LLM 重试机制、网格分割配置、边样式切换等

大约 **60% 的核心功能是原有的**，**40% 是你迭代后新增的**。你的迭代主要集中在：
1. **交互体验优化**（空格键、快捷键、缩放、悬停）
2. **数据持久化**（IndexedDB、自动保存、撤销/重做）
3. **工作流控制**（从节点执行、暂停点、批量操作）
4. **UI 增强**（分组、排列、工具栏、文档查看器）
